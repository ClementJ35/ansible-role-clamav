---
- name: Determine ClamAV package names (RedHat)
  set_fact:
    package_names:
      - clamav
      - clamav-update
  when: ansible_os_family == 'RedHat'

- name: Determine ClamAV package names (Debian)
  set_fact:
    package_names:
      - clamav-daemon
  when: ansible_os_family == 'Debian'

- name: Install ClamAV packages
  package:
    name: '{{ package_names }}'
    state: present

# Later versions of Fedora do not come with a cron implementation
# installed.
- name: Install cronie (Fedora)
  package:
    name: cronie
    state: present
  when: ansible_distribution == 'Fedora'

- name: Install virus_scan cron job
  copy:
    src: virus_scan.sh
    dest: /etc/cron.weekly/virus_scan
    mode: 0755

- name: Debian-specific setup
  block:
    # Unless you do this, systemd can sometimes get confused when you
    # try to start a service you just installed
    - name: Systemd daemon-reload
      systemd:
        daemon_reload: true

    # Debian seems to enable clamav-daemon by default
    - name: Disable clamav-daemon
      service:
        name: clamav-daemon
        enabled: no

    # freshclam is run via a cron job on RedHat, so there is no
    # service to start in that case
    - name: Start and enable freshclam
      service:
        name: clamav-freshclam
        enabled: yes
        state: started
  when: ansible_os_family == 'Debian'

- name: RedHat-specific setup
  block:
    - name: Create /var/log/clamav directory
      file:
        owner: root
        group: root
        mode: 0700
        path: /var/log/clamav
        state: directory

    # This happens automatically on Debian when we start the
    # clamav-freshclam service
    - name: Run freshclam (RedHat)
      command: /usr/bin/freshclam
      args:
        creates: /var/lib/clamav/bytecode.cvd
  when: ansible_os_family == 'RedHat'

- name: Wait for new signatures to be downloaded and installed by freshclam
  wait_for:
    timeout: 600
    path: /var/lib/clamav/bytecode.cvd
    state: present
